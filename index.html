<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RNL Invester</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase 9.23.0 compatibility library (Optimized for faster load) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <style>
        /* [STYLES ARE SAME AS PREVIOUS ITERATION, ENSURING DARK/LIGHT MODE SUPPORT] */
        html, body {
            margin: 0; padding: 0; height: 100%; overflow: hidden;
            font-family: ui-sans-serif, system-ui;
        }
        .layout-wrapper {
            width: 100vw; height: 100vh; max-width: 100%; display: flex;
            flex-direction: column; position: relative;
        }
        .header { height: 56px; flex-shrink: 0; z-index: 20; }
        .bottom-nav { height: 64px; flex-shrink: 0; z-index: 30; }
        .main-content { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .main-content-scroll { padding-bottom: 0; }
        @media (max-width: 767px) {
            .main-content-scroll { padding-bottom: 64px; }
        }
        .tab-content-panel { display: none; flex-grow: 1; overflow-y: auto; padding: 1rem; }
        .tab-content-panel.active { display: block; }
        .nav-button {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 4px 0; flex-grow: 1; font-size: 0.75rem; font-weight: 500;
            transition: all 0.2s ease; cursor: pointer; position: relative;
        }
        .bottom-nav .nav-button.active:after {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 70%;
            height: 3px;
            background-color: #f97316; /* Orange 500 */
            border-radius: 0 0 3px 3px;
        }

        /* Notification Badge Styling */
        .notification-badge {
            position: absolute;
            top: 4px;
            right: 12px;
            min-width: 18px;
            height: 18px;
            line-height: 18px;
            background-color: #ef4444; /* Red 500 */
            color: white;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: bold;
            text-align: center;
            padding: 0 4px;
            z-index: 40;
        }
        .desktop-badge { right: 8px; top: 10px; }
        .mobile-badge { right: 20%; top: 6px; }

        /* --- LOGIN PANEL CENTERING & STYLING FIX --- */
        .auth-form-container {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; justify-content: center; align-items: center;
            background-color: rgba(0, 0, 0, 0.8); /* Dark Overlay */
            z-index: 50;
        }
        .auth-form {
            background-color: #1f2937; /* Gray 800 (Default dark mode form bg) */
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            max-width: 400px; 
            width: 90%; 
        }
        .auth-form input, .auth-form textarea, .auth-form select {
            background-color: #374151; /* Gray 700 */
            border-color: #4b5563; /* Gray 600 */
            color: #e5e7eb;
            transition: all 0.2s;
        }
        .auth-form input:focus, .auth-form select:focus {
            border-color: #f97316; 
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.5); 
        }

        /* ------------------------------------------------------------- */
        /* --- A. LIGHT MODE STYLES (IMPROVED CONTRAST) --- */
        /* ------------------------------------------------------------- */
        body.light { background-color: #f0f4f8; color: #111827; }
        .light .layout-wrapper { background-color: #ffffff; }
        .light .header { background-color: #f97316; color: #ffffff; }
        .light .header h1 { color: #ffffff; }
        .light .bottom-nav { background-color: #111827; }
        .light .bottom-nav .nav-button { color: #d1d5db; }
        .light .bottom-nav .nav-button.active { color: #ffffff; }
        
        /* IMPROVEMENT: Better card background and input contrast */
        .light .bg-dark-card { background-color: #f8f8f8; border: 1px solid #e5e7eb; } 
        .light .bg-dark-card input, .light .bg-dark-card textarea, .light .bg-dark-card select { 
            background-color: #ffffff; 
            border-color: #d1d5db; 
            color: #1f2937; 
        }
        .light .auth-form { background-color: #ffffff; }
        .light .auth-form input, .light .auth-form select { 
            background-color: #f3f4f6; 
            border-color: #d1d5db; 
            color: #1f2937;
        }
        .light #auth-title, .light .auth-form button, .light .auth-form p { color: #1f2937; }
        
        .light .text-light-text { color: #1f2937; } 
        .light .text-dark-text { color: #1f2937; }
        .light .text-gray-200 { color: #111827; } 
        .light .text-gray-300 { color: #374151; }
        .light .text-gray-400 { color: #6b7280; }
        
        .light .top-nav .nav-button { color: #ffffff; }
        .light .top-nav .nav-button svg { color: #ffffff; }


        /* ------------------------------------------------------------- */
        /* --- B. DARK MODE STYLES (Default) --- */
        /* ------------------------------------------------------------- */
        body.dark { background-color: #111827; color: #e5e7eb; }
        .dark .layout-wrapper { background-color: #1f2937; } 
        .dark .header { background-color: #f97316; color: #1f2937; }
        .dark .header h1 { color: #1f2937; }
        .dark .bottom-nav { background-color: #1f2937; } 
        
        .dark .bg-dark-card { background-color: #374151; } 
        .dark .bg-dark-card input, .dark .bg-dark-card textarea, .dark .bg-dark-card select { 
            background-color: #1f2937; 
            border-color: #4b5563; 
            color: #e5e7eb; 
        }
        .dark .text-light-text { color: #e5e7eb; }
        .dark .text-dark-text { color: #1f2937; }

        .dark .text-gray-200 { color: #e5e7eb; }
        .dark .text-gray-300 { color: #d1d5db; }
        .dark .text-gray-400 { color: #9ca3af; }
    </style>
</head>
<body class="dark"> 

    <!-- 1. LOGIN/REGISTER MODAL (FIXED AND CENTERED) -->
    <div id="auth-guard" class="auth-form-container">
        <div id="auth-form" class="auth-form w-full">
            <h2 id="auth-title" class="text-3xl font-extrabold text-white mb-6 text-center">Login</h2>
            
            <div id="error-message" class="hidden bg-red-900 bg-opacity-30 border border-red-500 text-red-400 px-4 py-3 rounded-lg relative mb-4" role="alert">
                <strong class="font-bold">Error!</strong>
                <span class="block sm:inline" id="error-text"></span>
            </div>

            <form id="auth-form-inputs" onsubmit="event.preventDefault(); handleAuth()">
                <input type="text" id="auth-name" placeholder="Full Name" 
                        class="w-full p-3 mb-4 border rounded-lg hidden">
                <input type="tel" id="auth-mobile" placeholder="Mobile Number (e.g., 98XXXXXXXX)" 
                       pattern="[0-9]{10}" title="Must be 10 digits"
                        class="w-full p-3 mb-4 border rounded-lg hidden">
                        
                <input type="email" id="auth-email" placeholder="Email" required 
                       class="w-full p-3 mb-4 border rounded-lg">
                <input type="password" id="auth-password" placeholder="Password" required 
                       class="w-full p-3 mb-4 border rounded-lg">
                <input type="password" id="auth-confirm-password" placeholder="Confirm Password" 
                       class="w-full p-3 mb-6 border rounded-lg hidden">
                
                <button type="submit" id="auth-submit-btn" 
                        class="w-full bg-orange-500 text-white p-3 rounded-lg font-semibold transition hover:bg-orange-600 shadow-md">
                    Sign In
                </button>
            </form>


            <!-- ======================================================================================= -->

           

            <button id="auth-toggle-btn" onclick="toggleAuthMode()" 
                    class="w-full mt-4 text-sm text-yellow-400 hover:text-yellow-300 transition">
                Need an account? **Register**
            </button>
            
            <!-- NEW: Admin Link for easy access -->
            <p class="text-center mt-6 text-gray-500 text-xs">
                Admin? <a href="admin.html" target="_blank" class="text-orange-400 hover:text-orange-300 underline">Login Here</a>
            </p>
        </div>
    </div>

    <!-- 2. MAIN APPLICATION UI -->
    <div id="main-app" class="layout-wrapper hidden">
        
        <header class="header bg-orange-500 text-white flex items-center justify-between px-4 shadow-lg">
            <h1 class="text-xl font-bold font-">RNL invester</h1>
            
            <!-- DESKTOP NAVIGATION -->
            <nav id="top-nav" class="top-nav flex h-full items-center space-x-2">
                <div class="hidden md:flex h-full items-center space-x-1">
                    <button class="nav-button active" data-tab="tab-home" onclick="showTab('tab-home')">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7m-7-7v12a3 3 0 01-3 3H5a3 3 0 01-3-3V7.077a3 3 0 01.44-1.688zM10 16H8M16 16h-2"/></svg>
                        <span>Home</span>
                    </button>
                    <button class="nav-button" data-tab="tab-wallet" onclick="showTab('tab-wallet')">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
                        <span>Wallet</span>
                    </button>
                    <button class="nav-button" data-tab="tab-news-feed" onclick="showTab('tab-news-feed')">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 0V6a2 2 0 00-2-2M5 19h14M16 7h4m-4 7h4m-4 10v-7M4 14h6M4 18h6m-3-5h3"/></svg>
                        <span>News Feed</span>
                    </button>
                    <button class="nav-button relative" data-tab="tab-notification" onclick="showTab('tab-notification')">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.405L4 17h5m6 0v1a3 3 0 11-6 0v-1"/></svg>
                        <span>Notifications</span>
                        <div id="desktop-notification-badge" class="notification-badge desktop-badge hidden">0</div>
                    </button>
                    <button class="nav-button" data-tab="tab-profile" onclick="showTab('tab-profile')">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                        <span>Profile</span>
                    </button>
                    <button id="theme-button-desktop" class="nav-button" onclick="toggleDarkMode()">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h14a2 2 0 012 2v12a4 4 0 01-4 4h-3a2 2 0 01-2-2 2 2 0 00-2-2H9a2 2 0 00-2 2zm10-7h-2M7 7h.01M17 7h.01M7 11h.01M17 11h.01"/></svg>
                        <span>Theme (Dark)</span>
                    </button>
                </div>

                <!-- MOBILE TOP UTILITY NAV -->
                <div class="flex md:hidden h-full top-nav-mobile items-center space-x-1">
                    <button class="nav-button relative" data-tab="tab-notification" onclick="showTab('tab-notification')">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.405L4 17h5m6 0v1a3 3 0 11-6 0v-1"/></svg>
                        <div id="mobile-notification-badge" class="notification-badge mobile-badge hidden">0</div>
                    </button>
                    <button id="theme-button-mobile" class="nav-button" onclick="toggleDarkMode()">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h14a2 2 0 012 2v12a4 4 0 01-4 4h-3a2 2 0 01-2-2 2 2 0 00-2-2H9a2 2 0 00-2 2zm10-7h-2M7 7h.01M17 7h.01M7 11h.01M17 11h.01"/></svg>
                    </button>
                </div>
            </nav>
        </header>

        <!-- MAIN CONTENT AREA -->
        <div class="main-content">
            
            <!-- üè† HOME TAB -->
            <div id="tab-home" class="tab-content-panel active main-content-scroll">
                <h2 class="text-2xl font-bold mb-4 text-gray-200"> Application Overview</h2>
                
                <div class="p-6 bg-indigo-900 bg-opacity-30 border border-indigo-500 rounded-xl shadow-lg">
                    <p class="text-lg font-semibold text-indigo-300">Welcome to RNL invester</p>
                    <p class="text-sm text-indigo-400 mt-1">This application provides full-stack functionality for modern mobile and desktop use.</p>
                </div>
                
                <h3 class="text-xl font-semibold mt-6 mb-3 text-gray-200">
                    ‚ÑπÔ∏è About Our Features
                </h3>
                <div id="company-info-container" class="space-y-4 text-gray-300">
                    <p>
                        **Real-time Wallet:** Your balance updates instantly whenever an Admin changes the value in the Firebase console.
                    </p>
                    <p>
                        **Transaction History (Approved Only):** History is logged **only** when the Admin approves a request and changes your balance.
                    </p>
                    <p>
                        **Active Market Bonus:** Track the automatically calculated **Active Market Days** (starts counting after first deposit) to qualify for a **5% deposit bonus** after 30 active days!
                    </p>
                </div>

                <!-- Contact Us Section -->
                <h3 class="text-xl font-semibold mt-8 mb-3 text-gray-200">
                    üìû Contact Us
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <a href="https://wa.me/YOUR_NUMBER" target="_blank" class="p-4 text-center bg-dark-card rounded-lg hover:bg-gray-600 transition shadow-md">
                        <p class="font-semibold text-green-400">WhatsApp</p>
                    </a>
                    <a href="https://facebook.com/YOUR_PAGE" target="_blank" class="p-4 text-center bg-dark-card rounded-lg hover:bg-gray-600 transition shadow-md">
                        <p class="font-semibold text-blue-400">Facebook</p>
                    </a>
                    <a href="https://youtube.com/YOUR_CHANNEL" target="_blank" class="p-4 text-center bg-dark-card rounded-lg hover:bg-gray-600 transition shadow-md">
                        <p class="font-semibold text-red-400">YouTube</p>
                    </a>
                    <a href="mailto:support@myapp.com" target="_blank" class="p-4 text-center bg-dark-card rounded-lg hover:bg-gray-600 transition shadow-md">
                        <p class="font-semibold text-yellow-400">Email</p>
                    </a>
                </div>
            </div>

            <!-- üí≥ WALLET TAB -->
            <div id="tab-wallet" class="tab-content-panel main-content-scroll">
                <h2 class="text-2xl font-bold mb-4 text-gray-200">üí≥ Your Wallet</h2>
                
                <!-- Balance & Active Days -->
                <div class="bg-dark-card p-6 rounded-xl shadow-lg mb-6 border-l-4 border-green-500">
                    <div class="flex justify-between items-center">
                         <div>
                            <p class="text-sm font-medium text-green-300">Total Wallet Balance</p>
                            <p id="wallet-balance" class="text-4xl font-extrabold text-green-300 mt-1">‚Çπ0.00</p> 
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-medium text-gray-400">Active Market Days</p>
                            <p id="active-days-count" class="text-3xl font-extrabold text-white mt-1">0</p> 
                            <p id="first-deposit-date" class="text-xs text-gray-500 mt-1 italic">Deposit to start count.</p>
                        </div>
                    </div>
                   
                    <!-- --- Bonus Prompt Section --- -->
                    <!-- <div id="bonus-prompt" class="mt-4 pt-3 border-t border-gray-600 hidden">
                        <h3 class="text-lg font-semibold text-orange-400">
                            üéÅ Pending 5% Bonus: <span id="pending-bonus-amount">‚Çπ0.00</span>
                        </h3>
                        <p id="bonus-status-message" class="text-sm text-gray-400 mt-1">
                            You are eligible for the 5% bonus.
                        </p>
                        <button onclick="requestBonus()" class="w-full mt-3 bg-orange-600 text-white p-3 rounded-lg font-medium hover:bg-orange-700 transition shadow-md">
                            Request Bonus Credit
                        </button>
                    </div> -->
<!-- 5% Bonus Prompt -->
                <div id="bonus-prompt" class="hidden bg-yellow-900 p-4 rounded-xl shadow-xl border border-yellow-500 mb-6">
                    <h3 class="text-xl font-bold text-yellow-300 mb-2">üéÅ Your 5% Bonus is Ready!</h3>
                    <p id="bonus-status-message" class="text-gray-200 text-sm">You have accumulated **0 Active Days**.</p>
                    <div class="flex justify-between items-center mt-3">
                        <p class="text-lg font-bold text-white">Bonus Amount: <span id="pending-bonus-amount">‚Çπ0.00</span></p>
                        <button onclick="requestBonus()" class="bg-orange-500 text-white p-2 rounded-lg font-medium text-sm hover:bg-orange-600 transition">Request Bonus</button>
                    </div>
                </div>

                </div>

                <!-- --- Deposit/Payment Form --- -->
                <div class="bg-dark-card p-4 rounded-lg mb-6 shadow-md border border-gray-600">
                    <h3 class="text-lg font-semibold mb-3 text-blue-300">üí∏ Request Deposit (Payment)</h3>
                    <form onsubmit="event.preventDefault(); submitWalletRequest('deposit')">
                        <select id="deposit-method" required 
                            class="w-full p-3 mb-3 border rounded-lg text-light-text">
                            <option value="" disabled selected>Select Transaction Method</option>
                            <option value="Esewa">Esewa</option>
                            <option value="Khalti">Khalti</option>
                            <option value="Nepali Bank">Nepali Bank</option>
                            <option value="Indian Bank">Indian Bank</option>
                            <option value="Paytm">Paytm</option>
                        </select>
                        <input type="number" step="0.01" id="deposit-amount" placeholder="Amount (‚Çπ)" required 
                            class="w-full p-3 mb-3 border rounded-lg text-light-text">
                        <textarea id="deposit-details" placeholder="Your Transaction ID / Proof Details for Admin" rows="2" required
                            class="w-full p-3 mb-3 border rounded-lg text-light-text"></textarea>
                        <button type="submit" id="deposit-btn" class="w-full bg-blue-500 text-white p-3 rounded-lg font-medium hover:bg-blue-600 transition shadow-md">
                            Submit Deposit Request
                        </button>
                    </form>
                </div>

                <!-- --- Withdrawal Form --- -->
                <div class="bg-dark-card p-4 rounded-lg mb-6 shadow-md border border-gray-600">
                    <h3 class="text-lg font-semibold mb-3 text-red-300">üèß Request Withdrawal</h3>
                    <form onsubmit="event.preventDefault(); submitWalletRequest('withdrawal')">
                           <select id="withdrawal-method" required 
                            class="w-full p-3 mb-3 border rounded-lg text-light-text">
                            <option value="" disabled selected>Select Withdrawal Method</option>
                            <option value="Esewa">Esewa</option>
                            <option value="Khalti">Khalti</option>
                            <option value="Nepali Bank">Nepali Bank</option>
                            <option value="Indian Bank">Indian Bank</option>
                            <option value="Paytm">Paytm</option>
                        </select>
                        <input type="number" step="0.01" id="withdrawal-amount" placeholder="Amount (‚Çπ)" required 
                            class="w-full p-3 mb-3 border rounded-lg text-light-text">
                        <input type="text" id="withdrawal-account" placeholder="Bank/UPI/E-Wallet ID Details" required 
                            class="w-full p-3 mb-3 border rounded-lg text-light-text">
                        <button type="submit" id="withdrawal-btn" class="w-full bg-red-500 text-white p-3 rounded-lg font-medium hover:bg-red-600 transition shadow-md">
                            Submit Withdrawal Request
                        </button>
                    </form>
                </div>

                <!-- --- Transaction History --- -->
                <div class="mt-8">
                    <h3 class="text-xl font-bold mb-3 text-gray-200">üßæ Transaction History (Approved Only)</h3>
                    <div id="transaction-history-list" class="space-y-3">
                        <p class="text-gray-400 italic">No approved transactions found yet.</p>
                    </div>
                </div>
            </div>

            <!-- üì∞ NEWS FEED TAB -->
            <div id="tab-news-feed" class="tab-content-panel main-content-scroll">
                <h2 class="text-2xl font-bold mb-4 text-gray-200">üì∞ Market News & Activity</h2>
                
                <!-- Market Status Box -->
                <div id="market-status-box" class="p-4 rounded-lg mb-6 text-center shadow-2xl transition duration-500">
                    <p id="market-status-text" class="text-xl font-bold text-white"></p>
                    <p id="market-active-days-display" class="text-sm font-medium mt-1"></p>
                </div>

                <h3 class="text-xl font-semibold mb-3 text-gray-200">Latest Updates</h3>
                <div id="news-feed-list" class="space-y-4">
                    <!-- News items will be injected here by the script -->
                    <p class="text-gray-400 italic">Loading latest market news...</p>
                </div>
            </div>

            <!-- üîî NOTIFICATION TAB -->
            <div id="tab-notification" class="tab-content-panel main-content-scroll">
                <h2 class="text-2xl font-bold mb-4 text-gray-200">üîî My Notifications</h2>
                <div id="notifications-list" class="space-y-4">
                    <!-- Notifications will be injected here by the script -->
                    <p class="text-gray-400 italic">Listening for new messages...</p>
                </div>
                <button onclick="markAllNotificationsRead()" class="mt-4 w-full bg-gray-500 text-white p-3 rounded-lg font-medium hover:bg-gray-600 transition shadow-md">
                    Mark All as Read
                </button>
<!-- =================================here i also add gemini===================================== -->
                <!-- FEATURE 5: Delete Notification Button -->
                    <button onclick="deleteAllIndividualNotifications()" class="mt-3 w-full border border-red-500 text-red-500 p-3 rounded-lg font-medium hover:bg-red-600 hover:text-white transition shadow-md">
                        Delete All Personal Notifications
                    </button>
            </div>
            
            <!-- üë§ PROFILE TAB (IMPROVED DETAILS) -->
            <div id="tab-profile" class="tab-content-panel main-content-scroll">
                <h2 class="text-2xl font-bold mb-4 text-gray-200">üë§ User Profile</h2>
                <div class="space-y-6 max-w-md mx-auto p-6 bg-dark-card rounded-xl shadow-2xl border border-gray-600">
                    <div class="text-center">
                        <div id="profile-initials" class="w-32 h-32 bg-orange-500 rounded-full mx-auto flex items-center justify-center text-white text-4xl font-extrabold shadow-lg border-4 border-orange-400">?</div>
                        <p id="profile-name" class="mt-4 text-2xl font-extrabold text-white">Guest User</p>
                        <p id="profile-email" class="text-md text-gray-400">N/A</p>
                    </div>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between items-center p-3 rounded-lg border border-gray-500 dark:border-gray-700">
                            <span class="text-gray-400 font-medium">Mobile Number:</span>
                            <span id="profile-mobile" class="text-white font-semibold">N/A</span>
                        </div>
                        <div class="flex justify-between items-center p-3 rounded-lg border border-gray-500 dark:border-gray-700">
                            <span class="text-gray-400 font-medium">Account UID:</span>
                            <span id="profile-uid" class="text-xs text-gray-500 break-all">Not Authenticated</span>
                        </div>
                    </div>
<!-- =========================================codied form gemeini===================== -->
                    <!-- FEATURE 7: Reset Password Request -->
                    <button onclick="requestPasswordReset()" class="w-full bg-blue-600 text-white p-3 rounded-lg font-medium hover:bg-blue-700 transition shadow-md">
                        üîë Request Password Reset (Via Email)
                    </button>

                    <!-- FEATURE 2: Send Report -->
                    <div class="bg-gray-700 p-4 rounded-lg">
                        <h4 class="text-lg font-semibold text-gray-200 mb-2">Send Report to Admin</h4>
                        <textarea id="admin-report-text" placeholder="Describe the issue, bug, or suggestion..." rows="3" class="w-full p-2 bg-gray-600 border border-gray-500 rounded-lg text-white" required></textarea>
                        <button onclick="sendAdminReport()" class="w-full mt-2 bg-purple-600 text-white p-2 rounded-lg font-medium hover:bg-purple-700 transition">
                            Send Report
                        </button>
                    </div>

                    <button id="logout-button" class="w-full border border-red-500 text-red-500 p-3 rounded-lg hover:bg-red-500 hover:text-white transition shadow-md" onclick="signOutUser()">Log Out</button>
                </div>
            </div>
            
        </div>

        <!-- MOBILE BOTTOM NAV -->
        <nav id="bottom-nav" class="bottom-nav flex md:hidden bg-gray-900 border-t border-gray-700 shadow-xl">
            <button class="nav-button active" data-tab="tab-home" onclick="showTab('tab-home')">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7m-7-7v12a3 3 0 01-3 3H5a3 3 0 01-3-3V7.077a3 3 0 01.44-1.688zM10 16H8M16 16h-2"/></svg>
                <span>Home</span>
            </button>
            <button class="nav-button" data-tab="tab-wallet" onclick="showTab('tab-wallet')">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
                <span>Wallet</span>
            </button>
            <button class="nav-button" data-tab="tab-news-feed" onclick="showTab('tab-news-feed')">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 0V6a2 2 0 00-2-2M5 19h14M16 7h4m-4 7h4m-4 10v-7M4 14h6M4 18h6m-3-5h3"/></svg>
                <span>News</span>
            </button>
            <button class="nav-button" data-tab="tab-profile" onclick="showTab('tab-profile')">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                <span>Profile</span>
            </button>
        </nav>

    </div>

    <script>
        // --- 6. ‚ö†Ô∏è FIREBASE CONFIGURATION (CRITICAL) ‚ö†Ô∏è ---
        const firebaseConfig = {
            apiKey: "AIzaSyBIYf96Gt1aZenZbqvG0Lw_Gp_rhnw2sXA",
            authDomain: "first-prototype-c1ccf.firebaseapp.com",
            projectId: "first-prototype-c1ccf",
            storageBucket: "first-prototype-c1ccf.firebasestorage.app",
            messagingSenderId: "679797421506",
            appId: "1:679797421506:web:f53d0bebc26c9fad70525b",
            measurementId: "G-ZVJZGS10H5"
        };
        
        let app, auth, db;
        let userWalletData = { balance: 0.00, activeDays: 0, firstDepositDate: null, totalDeposits: 0, bonusRequested: false };
        let unsubscribeWallet = null;
        // let unsubscribeUser = null; 
        // let unsubscribeNotifications = null;
        // let unsubscribeNewsFeed = null;
        // let unsubscribeTransactions = null;
        // let unsubscribeMarketStatus = null;

        let unsubscribeUser = null; 
        let unsubscribeNotifications = null;
        let unsubscribeNewsFeed = null;
        let unsubscribeTransactions = null;
        let unsubscribeMarketStatus = null;
       

        // Helper for basic email validation
        function isValidEmail(email) {
            const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(String(email).toLowerCase());
        }

        // Helper to format currency in Rupees
        const formatter = new Intl.NumberFormat('en-IN', {
            style: 'currency',
            currency: 'INR',
            minimumFractionDigits: 2,
        });

        // --- AUTHENTICATION & INITIALIZATION ---
        
        function initializeFirebase() {
            try {
                // Initialize services
                app = firebase.initializeApp(firebaseConfig);
                auth = app.auth();
                db = app.firestore();
                db.settings({ timestampsInSnapshots: true });

                // Start Authentication Listener
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        startRealtimeListeners(user.uid);
                    } else {
                        clearProfile();
                        stopRealtimeListeners();
                    }
                });
            } catch (e) {
                console.error("Firebase Initialization Error. Check your configuration keys.", e);
            }
        }

        function startUserListener(userId) {
             const userDocRef = db.collection("users").doc(userId);
             unsubscribeUser = userDocRef.onSnapshot(doc => {
                 if (doc.exists) {
                     const data = doc.data();
                     const name = data.fullName || auth.currentUser?.displayName || 'User';
                     const mobile = data.mobileNumber || 'Not Set';
                     
                     document.getElementById('profile-name').textContent = name;
                     document.getElementById('profile-mobile').textContent = mobile;
                     
                     updateProfileUI(auth.currentUser);

                 } else {
                     updateProfileUI(auth.currentUser);
                 }
             }, error => {
                 console.error("User Details Snapshot Error:", error);
                 updateProfileUI(auth.currentUser);
             });
        }
        
        function updateProfileUI(user) {
            if (!user) return; 
            
            const email = user.email || 'N/A';
            const name = user.displayName || email.split('@')[0] || 'User'; 
            const initials = (name.charAt(0) + (name.includes(' ') ? name.split(' ')[1].charAt(0) : '')).toUpperCase();

            document.getElementById('profile-email').textContent = email;
            document.getElementById('profile-initials').textContent = initials.substring(0, 2);
            document.getElementById('profile-uid').textContent = user.uid;

            document.getElementById('auth-guard').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            showTab('tab-home'); 
        }
        
        function clearProfile() {
            document.getElementById('profile-name').textContent = 'Guest User';
            document.getElementById('profile-email').textContent = 'Please log in to see details';
            document.getElementById('profile-initials').textContent = '?';
            document.getElementById('profile-uid').textContent = 'Not Authenticated';
            document.getElementById('profile-mobile').textContent = 'N/A'; 
            
            document.getElementById('auth-guard').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
            showErrorMessage('');
        }
        
        function showErrorMessage(message) {
            const errorDiv = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            if (message) {
                errorText.textContent = message;
                errorDiv.classList.remove('hidden');
            } else {
                errorDiv.classList.add('hidden');
                errorText.textContent = '';
            }
        }
        
        let isRegisterMode = false;

        async function handleAuth() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            
            showErrorMessage('');
            
            if (!isValidEmail(email)) {
                 showErrorMessage('Please provide a real and valid email address.');
                 return;
            }

            if (isRegisterMode) {
                 const name = document.getElementById('auth-name').value;
                 const mobile = document.getElementById('auth-mobile').value;
                 const confirmPassword = document.getElementById('auth-confirm-password').value;

                 if (password !== confirmPassword) {
                     showErrorMessage('Passwords do not match.');
                     return;
                 }
                 if (!name || mobile.length !== 10) {
                      showErrorMessage('Please provide your Full Name and a 10-digit Mobile Number.');
                      return;
                 }
            
                 try {
                     const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                     const user = userCredential.user;
                     
                     await user.updateProfile({ displayName: name });

                     // 1. Create User Document 
                     const userDocRef = db.collection("users").doc(user.uid);
                     await userDocRef.set({
                         email: user.email,
                         fullName: name,
                         mobileNumber: mobile, 
                         registeredAt: firebase.firestore.FieldValue.serverTimestamp()
                     });
                     
                     // 2. Initialize Wallet
                     const walletDocRef = db.collection("userWallets").doc(user.uid);
                     await walletDocRef.set({
                         balance: 0.00,
                         userId: user.uid,
                         activeDays: 0, 
                         lastActiveDayChecked: null, 
                         firstDepositDate: null, 
                         totalDeposits: 0,
                         bonusRequested: false,
                         lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                     });

                     startRealtimeListeners(user.uid);
                 } catch (error) {
                     let errorMessage = 'An unknown error occurred.';
                     switch(error.code) {
                         case 'auth/invalid-email': errorMessage = 'Invalid email address format.'; break;
                         case 'auth/weak-password': errorMessage = 'Password should be at least 6 characters.'; break;
                         case 'auth/email-already-in-use': errorMessage = 'This email is already registered.'; break;
                         default: errorMessage = error.message; break;
                     }
                     showErrorMessage(errorMessage);
                 }

            } else {
                // Login Mode
                try {
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    startRealtimeListeners(userCredential.user.uid);
                } catch (error) {
                    let errorMessage = 'An unknown error occurred.';
                    switch(error.code) {
                        case 'auth/invalid-email': errorMessage = 'Invalid email address format.'; break;
                        case 'auth/user-not-found': errorMessage = 'No user found with this email.'; break;
                        case 'auth/wrong-password': errorMessage = 'Incorrect password.'; break;
                        default: errorMessage = error.message; break;
                    }
                    showErrorMessage(errorMessage);
                }
            }
        }
        
        function toggleAuthMode() {
            isRegisterMode = !isRegisterMode;
            const title = document.getElementById('auth-title');
            const submitBtn = document.getElementById('auth-submit-btn');
            const toggleBtn = document.getElementById('auth-toggle-btn');
            const nameInput = document.getElementById('auth-name');
            const mobileInput = document.getElementById('auth-mobile'); 
            const confirmPassInput = document.getElementById('auth-confirm-password');

            title.textContent = isRegisterMode ? 'Register' : 'Login';
            submitBtn.textContent = isRegisterMode ? 'Sign Up' : 'Sign In';
            toggleBtn.innerHTML = isRegisterMode 
                ? 'Already have an account? **Login**' 
                : 'Need an account? **Register**';
            
            // Show/Hide registration-specific fields
            nameInput.classList.toggle('hidden', !isRegisterMode);
            nameInput.required = isRegisterMode;
            mobileInput.classList.toggle('hidden', !isRegisterMode); 
            mobileInput.required = isRegisterMode;
            confirmPassInput.classList.toggle('hidden', !isRegisterMode);
            confirmPassInput.required = isRegisterMode;
            
            showErrorMessage('');
        }

        function signOutUser() {
            auth.signOut().then(() => {
                // Handled by onAuthStateChanged listener
            }).catch((error) => {
                console.error("Sign Out Error:", error);
            });
        }
        
        // --- REAL-TIME LISTENERS ---
        // function startRealtimeListeners(userId) {
        //     if (!db || !userId) return;
            
        //     startUserListener(userId); 
        //     startWalletListener(userId);
        //     startNotificationListener(userId);
        //     startTransactionListener(userId);
        //     startNewsFeedListener();
        // }


        function startRealtimeListeners(userId) {
            if (!db || !userId) return;
            
            startUserListener(userId); // New: Fetches name/mobile for profile
            startWalletListener(userId);
            startNotificationListener(userId); // New: Fetches all alerts/messages
            startTransactionListener(userId); // Updated: Fetches all transactions
            startNewsFeedListener();
        }

        function stopRealtimeListeners() {
            if (unsubscribeWallet) unsubscribeWallet();
            if (unsubscribeUser) unsubscribeUser(); 
            if (unsubscribeNotifications) unsubscribeNotifications();
            if (unsubscribeNewsFeed) unsubscribeNewsFeed();
            if (unsubscribeTransactions) unsubscribeTransactions();
            if (unsubscribeMarketStatus) unsubscribeMarketStatus();
            unsubscribeWallet = null;
            unsubscribeUser = null;
            unsubscribeNotifications = null;
            unsubscribeNewsFeed = null;
            unsubscribeTransactions = null;
            unsubscribeMarketStatus = null;
        }

        // --- LISTENER 1: WALLET & ACTIVE DAYS (AUTOMATED) ---
        function startWalletListener(userId) {
            const walletDocRef = db.collection("userWallets").doc(userId);
            unsubscribeWallet = walletDocRef.onSnapshot(doc => {
                const balanceDisplay = document.getElementById('wallet-balance');
                const activeDaysDisplay = document.getElementById('active-days-count');
                const firstDepositDateDisplay = document.getElementById('first-deposit-date');
                const marketDaysNewsDisplay = document.getElementById('market-active-days-display');
                const bonusPrompt = document.getElementById('bonus-prompt');
                const pendingBonusAmountDisplay = document.getElementById('pending-bonus-amount');

                if (doc.exists) {
                    const data = doc.data();
                    const oldBalance = userWalletData.balance; // Store old balance before update
                    
                    // Store data globally for withdrawal check and bonus logic
                    userWalletData = {
                        balance: data.balance || 0.00,
                        activeDays: data.activeDays || 0,
                        lastActiveDayChecked: data.lastActiveDayChecked,
                        firstDepositDate: data.firstDepositDate ? data.firstDepositDate.toDate() : null,
                        totalDeposits: data.totalDeposits || 0,
                        bonusRequested: data.bonusRequested || false
                    };

                    const { balance, activeDays, firstDepositDate, totalDeposits, bonusRequested } = userWalletData;
                    
                    // Feature 6: Send balance change notification
                    if (oldBalance !== 0 && oldBalance !== balance) {
                        sendBalanceChangeNotification(userId, oldBalance, balance);
                    }

                    balanceDisplay.textContent = formatter.format(balance);
                    activeDaysDisplay.textContent = activeDays;
                    
                    if (firstDepositDate) {
                        firstDepositDateDisplay.textContent = `Started: ${firstDepositDate.toLocaleDateString()}`;
                    } else {
                        firstDepositDateDisplay.textContent = `Deposit to start count.`;
                    }

                    if (marketDaysNewsDisplay) {
                        marketDaysNewsDisplay.textContent = `Active Days: ${activeDays}`;
                    }

                    // Bonus Logic Check (5% of total deposits)
                    const pendingBonus = totalDeposits * 0.05;
                    pendingBonusAmountDisplay.textContent = formatter.format(pendingBonus);
                    document.getElementById('bonus-status-message').innerHTML = `You have accumulated **${activeDays} Active Days** (${activeDays} / 30 required).`;


                    if (activeDays >= 30 && totalDeposits > 0 && !bonusRequested) {
                        bonusPrompt.classList.remove('hidden');
                    } else {
                        bonusPrompt.classList.add('hidden');
                    }

                } else {
                    balanceDisplay.textContent = formatter.format(0.00);
                    activeDaysDisplay.textContent = 0;
                    userWalletData = { balance: 0.00, activeDays: 0, firstDepositDate: null, totalDeposits: 0, bonusRequested: false };
                }
            }, error => {
                console.error("Wallet Snapshot Error:", error);
            });
        }


        // --- LISTENER 2: INDIVIDUAL & GLOBAL NOTIFICATIONS & BADGE ---
        function startNotificationListener(userId) {
            const notificationsList = document.getElementById('notifications-list');
            const individualRef = db.collection("userNotifications").doc(userId).collection("notifications").orderBy("timestamp", "desc").limit(10);
            const globalRef = db.collection("globalNotifications").orderBy("timestamp", "desc").limit(5);

            let individualNotifications = [];
            let globalNotifications = [];
            
            function combineAndRender() {
                // Combine and sort all notifications (max 15 items total)
                const allNotifications = [...individualNotifications, ...globalNotifications]
                                         .sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate())
                                         .slice(0, 15); 
                
                notificationsList.innerHTML = ''; 
                let unreadCount = 0;

                if (allNotifications.length === 0) {
                    notificationsList.innerHTML = '<p class="text-gray-400 italic">No recent messages.</p>';
                }

                allNotifications.forEach(notif => {
                    const isRead = notif.read || false;
                    const isGlobal = notif.isGlobal || false;
                    
                    if (!isRead) {
                        unreadCount++;
                    }

                    const notifDiv = document.createElement('div');
                    const bgColor = isRead ? 'bg-dark-card' : 'bg-blue-900 dark:bg-blue-900 dark:bg-opacity-30 border-yellow-500'; 
                    const borderStyle = isGlobal ? 'border-l-4 border-purple-500' : 'border-l-4 border-orange-500';
                    notifDiv.className = `p-4 ${bgColor} rounded-lg ${borderStyle} shadow-md text-light-text cursor-pointer`;
                    notifDiv.setAttribute('data-doc-id', notif.id);
                    
                    if (!isGlobal) {
                        // Only individual notifications can be marked read by the user
                        notifDiv.onclick = () => markNotificationRead(userId, notif.id);
                    } else {
                        // Global notifications are always considered 'read' on display
                        notifDiv.classList.add('cursor-default', 'opacity-80'); 
                    }
                    
                    let time = notif.timestamp ? notif.timestamp.toDate().toLocaleString() : 'Just now';
                    const icon = isGlobal ? 'üì¢' : 'üí¨';
                    const typeLabel = isGlobal ? 'System Broadcast' : 'Personal Message';

                    // Add a small delete control for personal (individual) notifications
                    let deleteBtnHtml = '';
                    if (!isGlobal) {
                        deleteBtnHtml = `\n                        <div class="mt-2">\n                            <button onclick="deleteIndividualNotification('${userId}', '${notif.id}')" class="text-xs text-red-400 hover:text-red-200 ml-2">Delete</button>\n                        </div>`;
                    }

                    notifDiv.innerHTML = `
                        <p class="font-semibold text-light-text ${isRead ? 'opacity-80' : 'font-extrabold'}">${icon} ${notif.title || 'Untitled Notification'} <span class="text-xs text-purple-400">(${typeLabel})</span></p>
                        <p class="text-sm text-gray-500 dark:text-gray-300 mt-1">${notif.content || 'No content provided.'}</p>
                        <p class="text-xs text-gray-400 dark:text-gray-500 mt-2">Received: ${time}</p>` + deleteBtnHtml;
                    notificationsList.appendChild(notifDiv);
                });

                updateNotificationBadges(unreadCount);
            }


            // Listener for Individual Notifications
            const unsubscribeIndividual = individualRef.onSnapshot(snapshot => {
                individualNotifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), isGlobal: false }));
                combineAndRender();
            }, error => {
                console.error("Individual Notifications Snapshot Error:", error);
            });
            
            // Listener for Global Notifications
            const unsubscribeGlobal = globalRef.onSnapshot(snapshot => {
                globalNotifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), isGlobal: true, read: true })); // Treat global as always read for badge
                combineAndRender();
            }, error => {
                console.error("Global Notifications Snapshot Error:", error);
            });

            // Set global unsubscribe function
            unsubscribeNotifications = () => {
                unsubscribeIndividual();
                unsubscribeGlobal();
            };
        }


        function updateNotificationBadges(count) {
             const badgeDesktop = document.getElementById('desktop-notification-badge');
             const badgeMobile = document.getElementById('mobile-notification-badge');
             
             if (count > 0) {
                 badgeDesktop.textContent = count;
                 badgeMobile.textContent = count;
                 badgeDesktop.classList.remove('hidden');
                 badgeMobile.classList.remove('hidden');
             } else {
                 badgeDesktop.classList.add('hidden');
                 badgeMobile.classList.add('hidden');
             }
        }
        
        async function markNotificationRead(userId, docId) {
             await db.collection("userNotifications").doc(userId).collection("notifications").doc(docId).update({ read: true });
        }
        
        async function markAllNotificationsRead() {
             const userId = auth.currentUser?.uid;
             if (!userId) return;

             // Only mark individual (non-global) notifications as read
             const snapshot = await db.collection("userNotifications").doc(userId).collection("notifications").where("read", "==", false).get();
             const batch = db.batch();
             snapshot.forEach(doc => {
                 batch.update(doc.ref, { read: true });
             });
             await batch.commit();
             alert("All personal messages marked as read!");
        }


        // --- LISTENER 3: TRANSACTION HISTORY (BALANCE CHANGE ONLY) ---
    
        function startTransactionListener(userId) {
             const historyList = document.getElementById('transaction-history-list');
             // *** CHANGE APPLIED HERE: Removed the 'where("balanceChange", "==", true)' filter to show ALL logs ***
             const transactionsRef = db.collection("userWallets").doc(userId).collection("transactions")
                                       .orderBy("timestamp", "desc").limit(20);
             
             unsubscribeTransactions = transactionsRef.onSnapshot(snapshot => {
                 historyList.innerHTML = '';
                 if (snapshot.empty) {
                     historyList.innerHTML = '<p class="text-gray-400 italic">No transaction logs found yet.</p>';
                     return;
                 }

                 snapshot.forEach(doc => {
                     const tx = doc.data();
                     
                     let typeDisplay = tx.type.toUpperCase().replace(/_/g, ' ');
                     let status = tx.status || 'Processed'; // Default to processed if status is missing
                     let color = 'text-gray-300';
                     let icon = 'üîÑ'; 
                     let sign = '';
                     const amount = tx.amount || 0;
                     
                     if (status === 'Pending') {
                         color = 'text-yellow-400';
                         icon = '‚è≥';
                         typeDisplay = `${typeDisplay} (PENDING)`;
                     } else if (tx.type === 'deposit') {
                         color = 'text-green-400';
                         icon = '‚¨ÜÔ∏è';
                         sign = '+';
                     } else if (tx.type === 'withdrawal') {
                         color = 'text-red-400';
                         icon = '‚¨áÔ∏è';
                         sign = '-';
                     } else if (tx.type.includes('bonus')) {
                         color = 'text-purple-400';
                         icon = 'üéÅ';
                         sign = '+';
                         typeDisplay = typeDisplay.includes('BONUS') ? typeDisplay : `${typeDisplay} CREDIT`;
                     } else if (tx.type === 'admin_credit') {
                         color = 'text-yellow-400';
                         icon = '‚ûï';
                         sign = '+';
                         typeDisplay = 'ADMIN CREDIT';
                     } else if (tx.type === 'admin_debit') {
                         color = 'text-red-400';
                         icon = '‚ûñ';
                         sign = '-';
                         typeDisplay = 'ADMIN DEBIT';
                     }
                     
                     const detailLine = tx.details || (tx.method ? `Method: ${tx.method}` : 'Transaction ID: N/A');
                     let time = tx.timestamp ? tx.timestamp.toDate().toLocaleString() : 'N/A';
                     
                     const txDiv = document.createElement('div');
                     txDiv.className = 'p-3 bg-gray-700 rounded-lg shadow-sm flex justify-between items-center border-l-4 border-gray-600 hover:bg-gray-600 transition';
                     txDiv.innerHTML = `
                          <div>
                              <p class="font-semibold ${color}">${icon} ${typeDisplay}</p>
                              <p class="text-xs text-gray-400 mt-1">${detailLine}</p>
                          </div>
                          <div class="text-right">
                              <p class="text-lg font-bold ${color}">${sign}${formatter.format(amount)}</p>
                              <p class="text-xs text-gray-500">${time}</p>
                          </div>
                      `;
                      historyList.appendChild(txDiv);
                  });
             }, error => {
                 console.error("Transaction History Error:", error);
                 historyList.innerHTML = '<p class="text-red-400 italic">Failed to load transaction history.</p>';
             });
        }

        // --- LISTENER 4: NEWS FEED, MARKET STATUS, AND ACTIVE DAY AUTO-INCREMENT ---
        function startNewsFeedListener() {
             // 4a. Market Status Listener (Single document)
             const marketStatusRef = db.collection("admin").doc("marketStatus");
             unsubscribeMarketStatus = marketStatusRef.onSnapshot(doc => {
                 const statusBox = document.getElementById('market-status-box');
                 const statusText = document.getElementById('market-status-text');
                 const data = doc.data() || { isOpen: false, lastUpdated: null };
                 
                 const isOpen = data.isOpen || false;
                 
                 // Update styling based on status
                 if (isOpen) {
                     statusBox.className = 'p-4 rounded-lg mb-6 text-center shadow-2xl transition duration-500 bg-green-700 dark:bg-green-700 border border-green-500';
                     statusText.textContent = '‚úÖ Market is OPEN';
                 } else {
                     statusBox.className = 'p-4 rounded-lg mb-6 text-center shadow-2xl transition duration-500 bg-red-700 dark:bg-red-700 border border-red-500';
                     statusText.textContent = 'üõë Market is CLOSED';
                 }
                 
                 const activeDays = userWalletData.activeDays || 0;
                 document.getElementById('market-active-days-display').textContent = `Active Days: ${activeDays}`;
                 
                 // --- AUTOMATIC ACTIVE DAY INCREMENT LOGIC (CRITICAL) ---
                 const userId = auth.currentUser?.uid;
                 if (userId && data.activeDayToday && userWalletData.firstDepositDate) {
                     const activeDayTimestamp = data.activeDayToday.toDate().getTime();
                     const lastCheckedTimestamp = userWalletData.lastActiveDayChecked ? userWalletData.lastActiveDayChecked.toDate().getTime() : 0;
                     
                     // Check if Admin has marked a new active day AND the user's check is older
                     if (activeDayTimestamp > lastCheckedTimestamp) {
                         const walletDocRef = db.collection("userWallets").doc(userId);
                         const newActiveDays = userWalletData.activeDays + 1;
                         
                         walletDocRef.update({
                             activeDays: newActiveDays,
                             lastActiveDayChecked: firebase.firestore.FieldValue.serverTimestamp()
                         }).catch(error => console.error("Error updating active days:", error));
                         console.log(`Active Day incremented to ${newActiveDays}.`);
                     }
                 }
                 // --- END ACTIVE DAY LOGIC ---

             }, error => {
                 console.error("Market Status Error:", error);
             });


             // 4b. News Feed Listener (Multiple documents)
             const newsFeedRef = db.collection("news").orderBy("timestamp", "desc").limit(10);
             unsubscribeNewsFeed = newsFeedRef.onSnapshot(snapshot => {
                 const newsList = document.getElementById('news-feed-list');
                 newsList.innerHTML = '';
                 
                 if (snapshot.empty) {
                     newsList.innerHTML = '<p class="text-gray-400 italic">No recent news updates from Admin.</p>';
                     return;
                 }
                 
                 snapshot.forEach(doc => {
                     const news = doc.data();
                     const newsDiv = document.createElement('div');
                     newsDiv.className = 'p-4 bg-dark-card rounded-lg border-l-4 border-yellow-500 shadow-md text-light-text';
                     
                     let time = news.timestamp ? news.timestamp.toDate().toLocaleString() : 'N/A';
                     
                     newsDiv.innerHTML = `
                         <p class="font-semibold text-yellow-300 dark:text-yellow-300 text-light-text">${news.title || 'Breaking News'}</p>
                         <p class="text-sm text-gray-500 dark:text-gray-300 mt-1">${news.content || 'No news content.'}</p>
                         <p class="text-xs text-gray-400 dark:text-gray-500 mt-2">Published: ${time}</p>
                     `;
                     newsList.appendChild(newsDiv);
                 });
             }, error => {
                 console.error("News Feed Error:", error);
                 document.getElementById('news-feed-list').innerHTML = '<p class="text-red-400 italic">Failed to load news feed.</p>';
             });
        }
        
        // --- WALLET REQUESTS & HISTORY LOGGING ---
        async function submitWalletRequest(type) {
            const user = auth.currentUser;
            if (!user) { alert("You must be logged in to submit a request."); return; }
            
            const amountInput = document.getElementById(`${type}-amount`);
            const methodInput = document.getElementById(`${type}-method`);
            const detailInput = type === 'deposit' ? document.getElementById('deposit-details') : document.getElementById('withdrawal-account');
            const submitBtn = document.getElementById(`${type}-btn`);

            const amount = parseFloat(amountInput.value);
            const method = methodInput.value;
            const details = detailInput.value;
            const account = type === 'withdrawal' ? details : '';
            const detailsLog = type === 'withdrawal' ? `Account/ID: ${account}` : details;

            if (!amount || amount <= 0 || !method || !details) {
                alert("Please fill in all required fields and ensure the amount is positive.");
                return;
            }

            // CRITICAL WITHDRAWAL CHECK
            if (type === 'withdrawal' && amount > userWalletData.balance) {
                alert(`‚ö†Ô∏è Please select an amount (${formatter.format(amount)}) under your total wallet balance (${formatter.format(userWalletData.balance)}).`);
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            try {
                // 1. Save request to Firestore for Admin review
                const requestDocRef = await db.collection("walletRequests").add({
                    userId: user.uid,
                    email: user.email,
                    type: type, 
                    method: method,
                    amount: amount,
                    details: detailsLog,
                    status: 'Pending',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                // 2. Log Pending Transaction History (Not visible in wallet history yet)
                const walletHistoryRef = db.collection("userWallets").doc(user.uid).collection("transactions");
                await walletHistoryRef.add({
                    type: type,
                    method: method,
                    amount: amount,
                    status: 'Pending', 
                    details: detailsLog,
                    balanceChange: false, // CRITICAL: Set to false, Admin must change to true later
                    requestId: requestDocRef.id,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Update firstDepositDate only on the very first deposit request
                if (type === 'deposit' && !userWalletData.firstDepositDate) {
                    await db.collection("userWallets").doc(user.uid).update({
                        firstDepositDate: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                // If deposit, update totalDeposits immediately to calculate pending bonus correctly
                if (type === 'deposit') {
                     await db.collection("userWallets").doc(user.uid).update({
                        totalDeposits: firebase.firestore.FieldValue.increment(amount)
                    });
                }

                alert(`${type.charAt(0).toUpperCase() + type.slice(1)} request of ${formatter.format(amount)} via ${method} submitted successfully! Admin will review shortly.`);
                
                // Clear the form
                amountInput.value = '';
                detailInput.value = '';
                methodInput.selectedIndex = 0;

            } catch (error) {
                console.error("Error submitting wallet request:", error);
                alert("Failed to submit request. Please try again.");
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = type === 'deposit' ? 'Submit Deposit Request' : 'Submit Withdrawal Request';
            }
        }

        // --- UI NAVIGATION & THEME ---
        function showTab(tabId) {
            document.querySelectorAll('.tab-content-panel').forEach(panel => {
                panel.classList.remove('active');
            });

            document.querySelectorAll('.nav-button').forEach(button => {
                button.classList.remove('active');
            });

            const selectedPanel = document.getElementById(tabId);
            if (selectedPanel) {
                selectedPanel.classList.add('active');
            }

            document.querySelectorAll(`.nav-button[data-tab="${tabId}"]`).forEach(button => {
                button.classList.add('active');
            });

            if (selectedPanel) {
                selectedPanel.scrollTop = 0;
            }
        }

        function toggleDarkMode() {
            const body = document.body;
            let isDark = body.classList.contains('dark');
            
            if (isDark) {
                body.classList.remove('dark');
                body.classList.add('light');
            } else {
                body.classList.remove('light');
                body.classList.add('dark');
            }
            
            const themeText = body.classList.contains('dark') ? 'Dark' : 'Light';
            const iconPath = body.classList.contains('dark') 
                ? 'M7 21a4 4 0 01-4-4V5a2 2 0 012-2h14a2 2 0 012 2v12a4 4 0 01-4 4h-3a2 2 0 01-2-2 2 2 0 00-2-2H9a2 2 0 00-2 2zm10-7h-2M7 7h.01M17 7h.01M7 11h.01M17 11h.01' 
                : 'M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z';
            
            document.getElementById('theme-button-desktop').querySelector('span').textContent = `Theme (${themeText})`;
            document.getElementById('theme-button-desktop').querySelector('svg path').setAttribute('d', iconPath);
            document.getElementById('theme-button-mobile').querySelector('svg path').setAttribute('d', iconPath);
        }


// ============================================================================================================
// Feature 3: Alert when typing email on signup
        function checkEmailAlert() {
             const emailInput = document.getElementById('auth-email');
             if (isRegisterMode && emailInput.value && !emailInput.getAttribute('data-alerted')) {
                 // Use a simple prompt/alert to prevent breaking the flow while enforcing the message
                 alert('‚ö†Ô∏è Please use your **real and active email account**. This is critical for account security and future password resets.');
                 emailInput.setAttribute('data-alerted', 'true');
             }
        }
        
        // Feature 7: Request Password Reset
        function requestPasswordReset() {
             const user = auth.currentUser;
             if (!user) {
                 alert("You must be logged in to request a password reset.");
                 return;
             }
             if (!user.email) {
                  alert("Your account does not have an email address associated with it.");
                  return;
             }

             auth.sendPasswordResetEmail(user.email)
                 .then(() => {
                     alert(`A password reset link has been sent to ${user.email}. Check your inbox (and spam folder)!`);
                 })
                 .catch((error) => {
                     console.error("Password Reset Error:", error);
                     alert("Failed to send reset email. Please ensure your email is correct and try again later.");
                 });
        }

        // Feature 2: Send Admin Report
        async function sendAdminReport() {
             const user = auth.currentUser;
             const reportText = document.getElementById('admin-report-text').value.trim();
             
             if (!user) { alert("You must be logged in to send a report."); return; }
             if (!reportText) { alert("Please write your report before sending."); return; }
             
             try {
                 await db.collection("adminReports").add({
                     userId: user.uid,
                     email: user.email,
                     report: reportText,
                     timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                     status: 'New'
                 });
                 
                 document.getElementById('admin-report-text').value = '';
                 alert("‚úÖ Your report has been successfully sent to the Admin for review. Thank you!");
             } catch (error) {
                 console.error("Error sending admin report:", error);
                 alert("Failed to send report. Please try again.");
             }
        }
        
        // Feature 6: Send Notification on Balance Change
        function sendBalanceChangeNotification(userId, oldBalance, newBalance) {
             const difference = newBalance - oldBalance;
             const isCredit = difference > 0;
             const title = `${isCredit ? '‚¨ÜÔ∏è Funds Credited' : '‚¨áÔ∏è Funds Debited'}`;
             const content = `${formatter.format(Math.abs(difference))} ${isCredit ? 'added' : 'removed'}. New balance: ${formatter.format(newBalance)}.`;
             
             db.collection("userNotifications").doc(userId).collection("notifications").add({
                 title: title,
                 content: content,
                 timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                 type: 'balance_change',
                 read: false
             }).catch(e => {
                 console.error("Error creating balance change notification:", e);
             });
        }

        // Feature 5: Delete Single Notification
        async function deleteIndividualNotification(userId, docId) {
            if (!confirm("Are you sure you want to delete this notification?")) return;
            try {
                await db.collection("userNotifications").doc(userId).collection("notifications").doc(docId).delete();
                // No need to alert, the listener update is instant
            } catch (error) {
                console.error("Error deleting notification:", error);
                alert("Failed to delete notification.");
            }
        }

        // Feature 5: Delete All Notifications
        async function deleteAllIndividualNotifications() {
             const userId = auth.currentUser?.uid;
             if (!userId) return;
             
             if (!confirm("WARNING: This will permanently delete ALL your personal notifications. Are you sure?")) return;

             try {
                 const snapshot = await db.collection("userNotifications").doc(userId).collection("notifications").get();
                 const batch = db.batch();
                 snapshot.forEach(doc => {
                     batch.delete(doc.ref);
                 });
                 await batch.commit();
                 alert("All personal notifications permanently deleted.");
             } catch (error) {
                 console.error("Error deleting all notifications:", error);
                 alert("Failed to delete all notifications.");
             }
        }

        // --- BONUS LOGIC FUNCTION ---
        async function requestBonus() {
             const user = auth.currentUser;
             if (!user) return;

             const walletDocRef = db.collection("userWallets").doc(user.uid);
             const { activeDays, totalDeposits, bonusRequested } = userWalletData;
             const pendingBonus = totalDeposits * 0.05;

             if (activeDays >= 30 && totalDeposits > 0 && !bonusRequested) {
                 // Send a request to Admin
                 await db.collection("walletRequests").add({
                     userId: user.uid,
                     email: user.email,
                     type: 'bonus_5_percent', 
                     amount: pendingBonus, // Sending calculated bonus amount
                     baseAmount: totalDeposits,
                     details: `Requesting 5% bonus (‚Çπ${pendingBonus.toFixed(2)}) after reaching ${activeDays} active days.`,
                     status: 'Pending Bonus Credit',
                     timestamp: firebase.firestore.FieldValue.serverTimestamp()
                 });
                 
                 // Mark as requested to prevent repeat button clicks
                 await walletDocRef.update({ bonusRequested: true });

                 document.getElementById('bonus-prompt').classList.add('hidden');
                 alert("5% Bonus Request submitted successfully! The Admin will update your balance shortly.");
             } else if (bonusRequested) {
                 alert("Bonus has already been requested or processed.");
                 document.getElementById('bonus-prompt').classList.add('hidden');
             } else {
                 alert("Conditions not met: Must have reached 30 Active Market Days and made a deposit.");
             }
        }

        // --- UI NAVIGATION & THEME ---
        function showTab(tabId) {
            document.querySelectorAll('.tab-content-panel').forEach(panel => {
                panel.classList.remove('active');
            });

            document.querySelectorAll('.nav-button').forEach(button => {
                button.classList.remove('active');
            });

            const selectedPanel = document.getElementById(tabId);
            if (selectedPanel) {
                selectedPanel.classList.add('active');
            }

            document.querySelectorAll(`.nav-button[data-tab="${tabId}"]`).forEach(button => {
                button.classList.add('active');
            });

            if (selectedPanel) {
                selectedPanel.scrollTop = 0;
            }
        }

        function toggleDarkMode() {
            const body = document.body;
            let isDark = body.classList.contains('dark');
            
            if (isDark) {
                body.classList.remove('dark');
                body.classList.add('light');
            } else {
                body.classList.remove('light');
                body.classList.add('dark');
            }
            
            const themeText = body.classList.contains('dark') ? 'Dark' : 'Light';
            const iconPath = body.classList.contains('dark') 
                ? 'M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 007.354-5.646z'
                : 'M12 3v1m6.364 1.636l-.707.707M21 12h-1v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-9a2 2 0 012-2h10V3m0 0a9 9 0 110 18 9 9 0 010-18z';
            
            document.getElementById('theme-button-desktop').querySelector('span').textContent = `Theme (${themeText})`;
            document.getElementById('theme-button-desktop').querySelector('svg path').setAttribute('d', iconPath);
            document.getElementById('theme-button-mobile').querySelector('svg path').setAttribute('d', iconPath);
        }

// ============================================================================================================
// Feature 3: Alert when typing email on signup
        function checkEmailAlert() {
             const emailInput = document.getElementById('auth-email');
             if (isRegisterMode && emailInput.value && !emailInput.getAttribute('data-alerted')) {
                 // Use a simple prompt/alert to prevent breaking the flow while enforcing the message
                 alert('‚ö†Ô∏è Please use your **real and active email account**. This is critical for account security and future password resets.');
                 emailInput.setAttribute('data-alerted', 'true');
             }
        }
        
        // Feature 7: Request Password Reset
        function requestPasswordReset() {
             const user = auth.currentUser;
             if (!user) {
                 alert("You must be logged in to request a password reset.");
                 return;
             }
             if (!user.email) {
                  alert("Your account does not have an email address associated with it.");
                  return;
             }

             auth.sendPasswordResetEmail(user.email)
                 .then(() => {
                     alert(`A password reset link has been sent to ${user.email}. Check your inbox (and spam folder)!`);
                 })
                 .catch((error) => {
                     console.error("Password Reset Error:", error);
                     alert("Failed to send reset email. Please ensure your email is correct and try again later.");
                 });
        }

        // Feature 2: Send Admin Report
        async function sendAdminReport() {
             const user = auth.currentUser;
             const reportText = document.getElementById('admin-report-text').value.trim();
             
             if (!user) { alert("You must be logged in to send a report."); return; }
             if (!reportText) { alert("Please write your report before sending."); return; }
             
             try {
                 await db.collection("adminReports").add({
                     userId: user.uid,
                     email: user.email,
                     report: reportText,
                     timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                     status: 'New'
                 });
                 
                 document.getElementById('admin-report-text').value = '';
                 alert("‚úÖ Your report has been successfully sent to the Admin for review. Thank you!");
             } catch (error) {
                 console.error("Error sending admin report:", error);
                 alert("Failed to send report. Please try again.");
             }
        }
        
        // Feature 6: Send Notification on Balance Change
        function sendBalanceChangeNotification(userId, oldBalance, newBalance) {
             const difference = newBalance - oldBalance;
             const isCredit = difference > 0;
             const title = `${isCredit ? '‚¨ÜÔ∏è Funds Credited' : '‚¨áÔ∏è Funds Debited'}`;
             const content = `${formatter.format(Math.abs(difference))} ${isCredit ? 'added' : 'removed'}. New balance: ${formatter.format(newBalance)}.`;
             
             db.collection("userNotifications").doc(userId).collection("notifications").add({
                 title: title,
                 content: content,
                 timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                 type: 'balance_change',
                 read: false
             }).catch(e => {
                 console.error("Error creating balance change notification:", e);
             });
        }

        // Feature 5: Delete Single Notification
        async function deleteIndividualNotification(userId, docId) {
            if (!confirm("Are you sure you want to delete this notification?")) return;
            try {
                await db.collection("userNotifications").doc(userId).collection("notifications").doc(docId).delete();
                // No need to alert, the listener update is instant
            } catch (error) {
                console.error("Error deleting notification:", error);
                alert("Failed to delete notification.");
            }
        }

        // Feature 5: Delete All Notifications
        async function deleteAllIndividualNotifications() {
             const userId = auth.currentUser?.uid;
             if (!userId) return;
             
             if (!confirm("WARNING: This will permanently delete ALL your personal notifications. Are you sure?")) return;

             try {
                 const snapshot = await db.collection("userNotifications").doc(userId).collection("notifications").get();
                 const batch = db.batch();
                 snapshot.forEach(doc => {
                     batch.delete(doc.ref);
                 });
                 await batch.commit();
                 alert("All personal notifications permanently deleted.");
             } catch (error) {
                 console.error("Error deleting all notifications:", error);
                 alert("Failed to delete all notifications.");
             }
        }

        // --- Start Application ---
        document.addEventListener('DOMContentLoaded', initializeFirebase);
        
    </script>

</body>
</html>
